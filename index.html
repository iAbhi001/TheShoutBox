<!DOCTYPE html>
<html>
<head>
    <title>Pro Shoutbox</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background: #f4f4f9; }
        #chat-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px; }
        #messages { border: 1px solid #eee; width: 350px; height: 300px; overflow-y: auto; padding: 10px; list-style: none; }
        #typing-status { font-size: 0.8em; color: gray; height: 1.2em; margin-bottom: 5px; }
        .count-badge { background: #007bff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.9em; }
    </style>
</head>
<body>
    <h2>Shoutbox <span id="count" class="count-badge">0</span></h2>
    <div id="chat-container">
        <div id="typing-status"></div>
        <ul id="messages"></ul>
        <input type="text" id="username" placeholder="Your Name" style="width: 80px;">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button onclick="sendMsg()">Send</button>
    </div>

    <script>
        const socket = new WebSocket('ws://localhost:8080');
        const input = document.getElementById('messageInput');
        const userField = document.getElementById('username');

        // --- 1. Handling Incoming Data ---
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'userCount') {
                document.getElementById('count').textContent = data.count;
            } 
            else if (data.type === 'typing') {
                document.getElementById('typing-status').textContent = data.user ? `${data.user} is typing...` : '';
            } 
            else if (data.type === 'chat') {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${data.user}:</strong> ${data.text}`;
                document.getElementById('messages').appendChild(li);
                document.getElementById('typing-status').textContent = ''; // Clear typing when message arrives
            }
        };

        // --- 2. Sending Messages ---
        function sendMsg() {
            const msg = {
                type: 'chat',
                user: userField.value || 'Guest',
                text: input.value
            };
            socket.send(JSON.stringify(msg));
            input.value = '';
        }

        // --- 3. Typing Indicator Logic ---
        input.addEventListener('input', () => {
            socket.send(JSON.stringify({
                type: 'typing',
                user: userField.value || 'Guest'
            }));
            
            // Clear typing status after 2 seconds of no input
            clearTimeout(window.typingTimer);
            window.typingTimer = setTimeout(() => {
                socket.send(JSON.stringify({ type: 'typing', user: null }));
            }, 2000);
        });
    </script>
</body>
</html>